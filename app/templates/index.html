{% extends "base.html" %}

{% block content %}
<div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4"
     hx-get="/history" 
     hx-trigger="loadHistory, load"
     hx-swap="innerHTML">
</div>

<form class="p-4 border-t border-gray-700" id="chat-form">
    <div class="flex gap-2">
        <input type="text" 
               name="message" 
               id="message-input"
               placeholder="Say something to the bird..."
               class="flex-1 bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-blue-500"
               required
               autocomplete="off">
        <button type="submit"
                class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-medium transition-colors">
            Send
        </button>
    </div>
</form>

<script>
    const form = document.getElementById('chat-form');
    const input = document.getElementById('message-input');
    const messagesDiv = document.getElementById('messages');
    const birdSounds = ['squak', 'chirp', 'tweet', 'worble', 'caw', 'peep', 'coo', 'trill'];
    
    let thinkingInterval = null;
    
    function generateThinkingSound() {
        const count = Math.floor(Math.random() * 3) + 2;
        let sounds = [];
        for (let i = 0; i < count; i++) {
            sounds.push(birdSounds[Math.floor(Math.random() * birdSounds.length)]);
        }
        return sounds.join(' ') + '...';
    }

    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.target.id === 'messages') {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    });

    document.getElementById('new-chat-btn').addEventListener('click', async function() {
        await fetch('/clear', { method: 'POST' });
        messagesDiv.innerHTML = '';
    });

    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const message = input.value.trim();
        if (!message) return;
        
        input.value = '';
        input.focus();
        
        const userHtml = '<div class="flex justify-end mb-4"><div class="bg-blue-600 text-white rounded-lg px-4 py-2 max-w-md">' + message + '</div></div>';
        const thinkingHtml = '<div class="flex justify-start mb-4" id="thinking-bubble"><div class="bg-gray-600 text-gray-300 rounded-lg px-4 py-2 max-w-md italic"><span id="thinking-text">' + generateThinkingSound() + '</span></div></div>';
        messagesDiv.innerHTML += userHtml + thinkingHtml;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        thinkingInterval = setInterval(function() {
            const thinkingText = document.getElementById('thinking-text');
            if (thinkingText) {
                thinkingText.textContent = generateThinkingSound();
            }
        }, 400);

        const formData = new FormData();
        formData.append('message', message);

        const response = await fetch('/chat', {
            method: 'POST',
            body: formData
        });

        const thinkingBubble = document.getElementById('thinking-bubble');
        if (thinkingBubble) {
            thinkingBubble.remove();
        }

        if (!response.ok) {
            const error = await response.json();
            const errorHtml = '<div class="flex justify-start mb-4"><div class="bg-red-800 text-red-100 rounded-lg px-4 py-2 max-w-md">' + error.detail + '</div></div>';
            messagesDiv.innerHTML += errorHtml;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            clearInterval(thinkingInterval);
            return;
        }

        const responseHtml = '<div class="flex justify-start mb-4"><div class="bg-gray-700 text-gray-100 rounded-lg px-4 py-2 max-w-md"><span id="bird-response"></span></div></div>';
        messagesDiv.innerHTML += responseHtml;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        const textSpan = document.getElementById('bird-response');

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    const data = line.slice(6);
                    if (data === '[DONE]') {
                        setTimeout(function() {
                            htmx.trigger('#messages', 'loadHistory');
                        }, 100);
                    } else {
                        textSpan.textContent += data;
                        await new Promise(r => setTimeout(r, 25));
                    }
                }
            }
        }
        
        clearInterval(thinkingInterval);
    });
</script>
{% endblock %}
